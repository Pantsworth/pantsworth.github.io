<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BABKA</title>
</head>

<div class="container bottom-pad">
    <hr>
    <img class="centered-img" src="../img/recipes/babka.jpg">
    <h2 class="centered-title">BABKA</h2>
    <p class='centered-title'>Originally from: <a href="https://smittenkitchen.com/2014/10/better-chocolate-babka/">Smitten Kitchen</a></p>
    <p class='centered-title notes'>Michael's Notes:<br>You can 100% make this without a stand mixer. Also I like to use about 60 grams of cocoa instead of just 30g. But then I am just trying to make things that are Chocolatey Enough™</p>
    <hr>
    <div class="row">
        <div class="col-lg-4 ingredients">
            <h2 class="centered-title">INGREDIENTS</h2>
            <br>
            <b>Dough:</b><br>
            4 1/4 cups (530 grams) all-purpose flour, plus extra for dusting<br>
            1/2 cup (100 grams) granulated sugar<br>
            2 teaspoons instant yeast<br>
            Grated zest of 1 small lemon or half an orange (our preference)<br>
            3 large eggs<br>
            1/2 cup water (cold is fine) and up to 1 to 2 tablespoons extra, if needed<br>
            3/4 teaspoon fine sea or table salt<br>
            2/3 cup unsalted butter (150 grams or 5.3 ounces) at room temperature<br>
            Sunflower or other neutral oil, for greasing<br>
            <br>
            <b>Filling</b><br>
            4 1/2 ounces (130 grams) dark chocolate (or approximately 3/4 cup chocolate chips)<br>
            1/2 cup (120 grams) unsalted butter, cold is fine<br>
            Scant 1/2 cup (50 grams) powdered sugar<br>
            1/3 cup (30 grams) cocoa powder<br>
            1/4 teaspoon cinnamon [optional]<br>
            <br>
            <br>
            <b>Syrup</b><br>
            1/3 cup water<br>
            6 tablespoons (75 grams) granulated sugar<br>
            <br>
            <b>YIELD:</b> 2 loaf-sized chocolate babkas

        </div>

        <div class="col-lg-8 with-borders">
            <h2 class="centered-title">DIRECTIONS</h2>
            <div id="steps" class="steps">
            </div>
        </div>
    </div>
</div>
    <a href="../recipes.html"><p class="centered-title">Recipes Home</p></a>
</html>

<script src="https://cdnjs.cloudflare.com/ajax/libs/annyang/2.4.0/annyang.min.js"></script>
<link rel="stylesheet" type="text/css" href="../css/recipestyle.css">


<script>
//************************************** KEYPRESSES *************************************

document.onkeydown = function(e) {
    switch (e.keyCode) {
        case 37:
            repeatStep();
//            console.log("left");
            break;
        case 38:
            previousStep();
//            console.log("up");
            break;
        case 39:
//            console.log("right");
            break;
        case 40:
            nextStep();
//            console.log("down");
            break;
    }
};
</script>

<script>
    //************************************** TABLE OF CONTENTS ************************************
    //                              VARIABLE SETUP
    //                              SPEECH REC SETUP
    //                              STARTUP AND COMMAND FUNCTIONS
    //                              SPEECH REC RESPONSES (getWitResponse)
    //                              INGREDIENT AMOUNTS
    //                              TEXT TO SPEECH
    //                              UI
    //                              STEP CHANGES
    //                              TIMERS



    //************************************** VARIABLE SETUP *************************************

    ingredients_list = ["1 teaspoon salt", "2 teaspoons vanilla extract", "one large egg", "one large egg yolk",
        "1 and 3 fourths of a cup all-purpose flour", "14 tablespoons unsalted butter, or one point seven five sticks",
        "one half teaspoon baking soda", "one half cup granulated sugar", "three fourths of a cup dark brown sugar",
        "one point five cups bittersweet chocolate chips"];

    step_list = ["","1. Make the dough: <br>Combine the flour, sugar, yeast and zest in the bottom of the bowl of a stand mixer. Add eggs and 1/2 cup water, mixing with the dough hook until it comes together; this may take a couple minutes. It’s okay if it’s on the dry side, but if it doesn’t come together at all, add extra water, 1 tablespoon at a time, until the dough forms a mass. <br><br>With the mixer on low, add the salt, then the butter, a spoonful at a time, mixing until it’s incorporated into the dough. Then, mix on medium speed for 10 minutes until dough is completely smooth; you’ll need to scrape the bowl down a few times. I usually found that after 10 minutes, the dough began to pull away from the sides of the bowl. If it doesn’t, you can add 1 tablespoon extra flour to help this along.",

        "2. Coat a large bowl with oil (or scrape the dough out onto a counter and oil this one) and place dough inside, cover with plastic and refrigerate. Leave in fridge for at least half a day, preferably overnight. [Dough will not fully double, so don’t fret if it doesn’t look like it grew by more than half.][To make this on the same day, see my fourth note below.]",

        "3. Make filling: Melt butter and chocolate together until smooth. Stir in powdered sugar and cocoa; mixture should form a spreadable paste. Add cinnamon, if desired. [If you’re wondering what happened to the pecans and granulated sugar, see my third note below.]",

        "4. Assemble loaves: Coat two 9-by-4-inch (2 1/4 or 1kg) loaf pans with oil or butter, and line the bottom of each with a rectangle of parchment paper. Take half of dough from fridge (leave the other half chilled). Roll out on a well-floured counter to about a 10-inch width (the side closest to you) and as long in length (away from you) as you can when rolling it thin, likely 10 to 12 inches.",

        "5. Spread half of chocolate mixture evenly over the dough, leaving a 1/2-inch border all around. Brush the end farthest away from you with water. Roll the dough up with the filling into a long, tight cigar. Seal the dampened end onto the log. I found that transferring the log to a lightly floured baking tray in the freezer for 10 to 15 minutes made it much, much easier to cut cleanly in half. Repeat with second dough.",

        "6. Trim last 1/2-inch off each end of log. Gently cut the log in half lenghtwise and lay them next to each other on the counter, cut sides up. Pinch the top ends gently together. Lift one side over the next, forming a twist and trying to keep the cut sides facing out (because they’re pretty). Don’t worry if this step makes a mess, just transfer the twist as best as you can into the prepared loaf pan. In one batch, mine was long enough to “S” inside the pan and I nested the trimmed ends of the log in the openings. Even if you don’t (and choose to bake them separately in a little pan, as I did in other batches), the dough will fill in any gaps by the time it’s done rising and baking, so don’t worry.",

        "7. Cover with a damp tea towel and leave to rise another 1 to 1 1/2 hours at room temperature. Repeat process with second loaf.",

        "8. Bake and finish cakes: Heat oven to 375°F (190°C). Remove towels, place each loaf on the middle rack of your oven. Bake for 30 minutes, but there’s no harm in checking for doneness at 25 minutes. A skewer inserted into an underbaked babka will feel stretchy/rubbery inside and may come back with dough on it. When fully baked, you’ll feel almost no resistance. If you babka needs more time, put it back, 5 minutes at a time then re-test. If it browns too quickly, you can cover it with foil.",

        "9. While babkas are baking, make syrup: Bring sugar and water to a simmer until sugar dissolves. Remove from heat and set aside to cool somewhat. As soon as the babkas leave the oven, brush the syrup all over each. It will seem like too much, but will taste just right — glossy and moist. Let cool about halfway in pan, then transfer to a cooling rack to cool the rest of the way before eating (an adorable suggestion from Ottolenghi — don’t worry, we know you’re going to eat it warm).",


        "10. A whole bunch of notes:<br>Babkas keep for a few days at room temperature. Longer, I’d freeze them. They freeze and defrost really well.<br>#1 I made a few ingredient changes: I used granulated sugar instead of the superfine suggested, because it’s hard to get it doesn’t seem essential here. Unsure of what “fast-rising active dry yeast” was, I used active dry yeast the first time and it barely rose; I used rapid rise or instant yeast the second and third: voila. You should use this. I had large eggs instead of extra-large; this wasn’t a problem. I also increased the salt in the dough and add a little optional cinnamon to the chocolate filling. Oh, and we preferred orange zest over lemon in the dough.<br>#2 The next set of changes was structural: I found the amount of syrup to be way too much and halved it in my second and third batches; it will still seem like a lot, but it’s just right once it sinks in and glosses up. I found that rolling the log out from a 15-inch side made too long of a twisted rope to fit a loaf pan; a 10-inch width fit better. I got a cleaner cut from transferring the rolled log to the freezer for 10 to 15 minutes before splitting it.<br>#3 Pecans and sugar: In the original recipe, after you spread the chocolate paste filling over the rolled-out dough, you sprinkle it with pecans and sugar, and if you’re me, you might mix a little cinnamon into that sugar. However, I found that these dry ingredients on top of the paste made it harder to assemble the final twisted shape — after the log is split, they make the layers fan open and hard to manage. I made one loaf (not photographed) without them and it was much, much easier to manage. Between that and the fact that my family doesn’t like nuts in baked goods, I’ll skip it going forward. If you’d like to add them, however, you’ll want to toast and chop 1 cup (100 grams) pecans and have 2 teaspoons sugar ready. Sprinkle half of each over each chocolate-slicked babka dough before rolling.<br>#4 To make this a single-day recipe: One thing I tried that wasn’t terribly successful was skipping the overnighting part of the recipe. While you can let it rise at room temperature instead (you’ll need 3 full hours for it to almost double), it’s not to your advantage because the buttery dough is much much easier to roll out and form into a log when it’s cold. If you want this to be a single-day process, however, once your dough is done rising, put it in the fridge for 30 before rolling it out. Trust me, letting the fridge firm up the dough helps tremendously.<br>#5 Without a stand mixer: This dough can be made, but the part where you need to beat and mash the butter into the tough dough will be tricky, quite an arm workout. It can/will eventually come together, however.];"];

    current_step = 1;
    stop_timer1 = false;
    stop_timer2 = false;
    wit_result = "";

    do_speech= false;
    fancy_steps = false;

    //************************************** FETCHES WIT RESPONSE + RUNS FUNCTIONS *************************************
    var getWitResponse = function (fulltext) {

        responding();
        console.log(fulltext);
        fulltext = fulltext.toLowerCase();


        next_test = fulltext.indexOf("next");
        previous_test = fulltext.indexOf("previous");
        back_test = fulltext.indexOf("back");
        last_test = fulltext.indexOf("last");
        repeat_test = fulltext.indexOf("repeat");
        timer_test = fulltext.indexOf("timer");
        hello_test = fulltext.indexOf("hello");
        hi_test = fulltext.indexOf("hi");
        high_test = fulltext.indexOf("high");
        cancel_test = fulltext.indexOf("cancel");


        document.getElementById('log').innerHTML= "I heard: " + fulltext + "<br>" + document.getElementById('log').innerHTML;


        // CATCH ALL THE STEP QUERIES TO SPEED RETURNS (VERY SIMPLE PROCESSING)
        if ((fulltext.indexOf("next") !== -1) || (fulltext.indexOf("forward")!==-1))  {
            nextStep();
        }
        else if ((previous_test !== -1) || (last_test!==-1) ||(back_test!==-1)) {
            previousStep();
        }
        else if ((hello_test!=-1) || (hi_test!=-1) || (high_test!=-1)) {
            su.text = "Hi!";
            if (do_speech==true) { sayThings();}
        }
        else if (((fulltext.indexOf("repeat")!==-1) && fulltext.indexOf("step")!==-1) || (fulltext.indexOf("current")!=-1)) {
            repeatStep();
        }

        else if (timer_test!=-1) {
            console.log("setting timer...");
//            var thenum = fulltext.match(/\d/g);
//            numb = thenum.join("");
//            console.log("setting timer for " + thenum.toString() + " minutes");
//
//            initializeClock('timerdiv', thenum, "Cookies");
//            console.log(parseInt(fulltext));
            if (cancel_test!=-1) {
                console.log("cancelling");
                cancelTimers();
            }
            else if ((fulltext.indexOf("how much")!=-1) || (fulltext.indexOf("left"))) {
            }
            else if ((fulltext.indexOf("cancel"))!=-1) {

            }
//            else if ((fulltext.indexOf("set")!=-1) || (fulltext.indexOf("make")!=-1)) {
//                var thenum = fulltext.match(/\d/g);
//                console.log("setting timer");
//                initializeClock('timerdiv', thenum, "Cookies");
//            }
        }



        else {
            result_object = $.ajax({
                url: 'https://api.wit.ai/message',
                data: {
                    'q': fulltext,
                    'access_token': 'AXIII6X7MAX2KW6FD27UFMT3VVQXM6WO'
                },
                dataType: 'jsonp',
                method: 'GET',
                success: function (response) {
                    wit_result = response;
                    console.log("success!", response);
                    console.log(response['outcomes']);

                    try {
                        ingredient = wit_result['outcomes'][0]['entities']['food'][0]['value'];
                        if (typeof(wit_result['outcomes'][0]['entities'] !== 'undefined')) {
                            if (typeof(wit_result['outcomes'][0]['entities']['food'][0]['value']) !== 'undefined') {
                                console.log(wit_result['outcomes'][0]['entities']['food'][0]['value']);
                                ingredient_amounts();
                            }
                        }
                        else {
                            su.text = "Response Failed";
                            if (do_speech==true) { sayThings();}
                        }
                    }

                    catch (TypeError) {
                        su.text = "Response Failed";
                        if (do_speech==true) { sayThings();}
                    }
                }
            });
        }
        listening();
    };


    //************************************** SET UP SPEECH RECOGNITION *************************************

    // Test browser support
    window.SpeechRecognition = window.SpeechRecognition ||
            window.webkitSpeechRecognition ||
            null;
    if (window.SpeechRecognition === null) {
        document.getElementById('ws-unsupported').classList.remove('hidden');
        document.getElementById('button-play-ws').setAttribute('disabled', 'disabled');
        document.getElementById('button-stop-ws').setAttribute('disabled', 'disabled');
        console.log("can't do speech rec")
    }

    else {
        var recognizer = new window.SpeechRecognition();
        var transcription = document.getElementById('transcription');
        var log = document.getElementById('log');

        //text-to-voice stuff
        var su = new SpeechSynthesisUtterance();
        su.rate = 0.75;
        su.lang = "en";
        su.text = "Haggis World";
        if (do_speech==true) { sayThings();}
    }


    //************************************** STARTUP, COMMANDS*************************************

    function startRec() {

    }

    var testResponse = function testResponse() {
        console.log("HIIIIIIIIIII");
        su.text = "Hi!";
        if (do_speech==true) { sayThings();}
    };

    var commands = {
        'Computer *fulltext': getWitResponse,
        'hi computer': testResponse,
        'hello there': testResponse
    };

    if ((annyang)&&(do_speech==true)) {
        // Add our commands to annyang
        annyang.addCommands(commands);

        // Start listening. You can call this here, or attach this call to an event, button, etc.
        annyang.start({autoRestart: true});
        console.log("listening");
        startUp();
    }

    else {
        startUp();

    }


    function startUp() {
        dir_list = "";
        for (i=1; i<step_list.length;i++) {
            dir_list = dir_list + "<div" + " id=" + "step" + i.toString() +  "><br>" + step_list[i] + "<br></div>";
        }
//        console.log(dir_list);
        document.getElementById('steps').innerHTML = dir_list;
        
        // sometimes you don't want fancy steps
        if (fancy_steps) {
        document.getElementById("step" + current_step.toString()).innerHTML = "<b><h2>" + document.getElementById('step' + current_step).innerHTML + "</h2></b>";
    }
//        initializeClock('timerdiv', 1.5);
    }


    //************************************** SPEAKS INGREDIENT AMOUNTS *************************************
    function ingredient_amounts() {
        found = false;
        spoken_text = "";
        su.text = "";
        search_term = wit_result['outcomes'][0]['entities']['food'][0]['value'].toString();


        for (i=0; i < ingredients_list.length; i++) {
//            console.log(ingredients_list[i]);
            console.log("search term is: " + search_term);
            if (search_term == "flower")  { result = "flour"; }
            result = ingredients_list[i].indexOf(wit_result['outcomes'][0]['entities']['food'][0]['value'].toString());
//            console.log(result);
            if (result == -1) { }
            else {
                if (!found) {
                    su.text = ingredients_list[i].toString();
                }
                else {
                    su.text = su.text + " " + ingredients_list[i].toString();
                }
//                console.log("the spoken text is: " + su.text);
                found=true;
//                console.log("FOUND!!!!");
            }
        }

        if (!found) {
            su.text = "There isn't even" + wit_result['outcomes'][0]['entities']['food'][0]['value'].toString() + " in this recipe";
        }
        if (do_speech=true) {sayThings();}
    }



    //************************************** TEXT TO SPEECH *************************************

    function sayThings() {
        annyang.pause();
        appendToLog();
        speechSynthesis.speak(su);
        annyang.resume();
    }

    function consoleSayThings(string) {
        responding();
        annyang.pause();
        su.text = string;
        appendToLog();
        speechSynthesis.speak(su);
        annyang.resume();
    }



    //************************************** UI ELEMENTS *************************************
    function responding() {
        document.getElementById('status').innerHTML= "Responding...";
        document.getElementById('ding').play();
    }

    function listening() {
        document.getElementById('status').innerHTML= "Listening...";
    }

    function appendToLog() {
        //TRUNCATE LONG PHRASES
        result = "";
        if (su.text.length > 50) {
            result = su.text.substring(0,50).toString() + "..."
        }
        // TRUNCATE LONG LOG
        if (document.getElementById('log').innerHTML.length > 300) {
            document.getElementById('log').innerHTML = result + "<br>" + document.getElementById('log').innerHTML.toString().substring(0,250);
        }
        else {
            document.getElementById('log').innerHTML = su.text + "<br>" + document.getElementById('log').innerHTML;
        }
    }

    function repeatStep() {
        annyang.pause();
        su.text = step_list[current_step];
        appendToLog();
        speechSynthesis.speak(su);
        annyang.resume();
    }



    //************************************** STEP CHANGES *************************************
    function nextStep() {
        document.getElementById('ding').play();
        current_step = current_step+1;

        // REMOVE FORMATTING FROM OLD STEP
        document.getElementById("step" + (current_step-1).toString()).innerHTML = step_list[current_step-1];

        // BOLD and HEADLINE THE NEW STEP
        document.getElementById("step" + current_step.toString()).innerHTML = "<b><h2>" + document.getElementById('step' + current_step).innerHTML + "</h2></b>";

        su.text = step_list[current_step];
        if (do_speech==true) { sayThings(); }
    }

    function previousStep() {
        if (current_step !== 1) {
            current_step = current_step - 1;
            // REMOVE FORMATTING FROM OLD STEP
            document.getElementById("step" + (current_step+1).toString()).innerHTML = step_list[current_step+1];

            // BOLD and HEADLINE THE NEW STEP
            document.getElementById("step" + current_step.toString()).innerHTML = "<b><h1 class='currentstep'>" + document.getElementById('step' + current_step).innerHTML + "</h1></b>";
            su.text = step_list[current_step];

        }

        else {
            su.text = "You are on the first step. First step is: " + step_list[current_step];
        }
        if (do_speech==true) { sayThings();}
    }




    //************************************** TIMERS *************************************

    // TIMER code thanks to https://www.sitepoint.com/build-javascript-countdown-timer-no-dependencies/
    function getTimeRemaining(endtime){
        var t = Date.parse(endtime) - Date.parse(new Date());
        var seconds = Math.floor( (t/1000) % 60 );
        var minutes = Math.floor( (t/1000/60) % 60 );
//        var hours = Math.floor( (t/(1000*60*60)) % 24 );
        return {
            'total': t,
            'minutes': minutes,
            'seconds': seconds
        };
    }

    function cancelTimers() {
        stop_timer1 = true;
        stop_timer2 = true;
        document.getElementById('timerdiv').innerHTML = "";
        document.getElementById('timerdiv2').innerHTML = "";
        su.text = "Timers are cancelled";
        if (do_speech==true) { sayThings();}
    }


    function initializeClock(id, duration, label){
        stop_timer1 = false;
        stop_timer2 = false;
        var endtime = new Date();

        if (duration % 1 === 0) {
            endtime.setMinutes(endtime.getMinutes()+duration);  }
        else {
            remainder = (duration % 1);
            minutes_duration = duration - remainder;
            endtime.setMinutes(endtime.getMinutes()+minutes_duration);
            endtime.setSeconds(endtime.getSeconds()+(remainder*60));
        }

        var clock = document.getElementById(id);


        // IF WE ALREADY HAVE A TIMER, MAKE A NEW ONE
        if (document.getElementById('timerdiv').innerHTML.indexOf("Time")!=-1) {
                initializeClock('timerdiv2', duration, label);
        }

        var timeinterval = setInterval(function(){
            if (stop_timer1) {
                clearInterval(timeinterval)
            }
            else {
                var t = getTimeRemaining(endtime);
                clock.innerHTML = label.toString() + ': ' + t.minutes + ":" + t.seconds;
                if (t.total <= 0) {
                    su.text = "Timer has finished";
                    sayThings();
                    clearInterval(timeinterval);
                }
            }
        },1000);

        su.text = "Set Timer for " + duration.toString() + " minutes";
        if (do_speech==true) { sayThings();}
    }

</script>

